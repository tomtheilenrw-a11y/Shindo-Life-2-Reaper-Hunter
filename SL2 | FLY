--// CONFIG
local FLY_SPEED = 600
local SAFE_CHECK_DISTANCE = 500
local TELEPORT_DISTANCE = 1000
local TOGGLE_KEY = Enum.KeyCode.P

--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local lp = Players.LocalPlayer

--// STATE
local flying = false
local bv, bg
local flyConn
local noclipConn

--// ALWAYS-ON NOCLIP
local function enableNoclip(char)
    if noclipConn then return end
    noclipConn = RunService.Stepped:Connect(function()
        for _, v in ipairs(char:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = false
            end
        end
    end)
end

--// ONE-TIME TELEPORT ON SPAWN
local function teleportOnce(hrp)
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= lp and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local otherHRP = p.Character.HumanoidRootPart
            local dist = (hrp.Position - otherHRP.Position).Magnitude

            if dist < SAFE_CHECK_DISTANCE then
                local offset = Vector3.new(
                    math.random(-TELEPORT_DISTANCE, TELEPORT_DISTANCE),
                    0,
                    math.random(-TELEPORT_DISTANCE, TELEPORT_DISTANCE)
                )
                hrp.CFrame = CFrame.new(hrp.Position + offset)
                break
            end
        end
    end
end

--// START FLY
local function startFly(hrp)
    if flying then return end
    flying = true

    bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
    bv.Velocity = Vector3.zero
    bv.Parent = hrp

    bg = Instance.new("BodyGyro")
    bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
    bg.P = 20000
    bg.CFrame = workspace.CurrentCamera.CFrame
    bg.Parent = hrp

    flyConn = RunService.RenderStepped:Connect(function()
        local cam = workspace.CurrentCamera
        local move = Vector3.zero

        if UIS:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end

        bv.Velocity = move * FLY_SPEED
        bg.CFrame = cam.CFrame
    end)
end

--// STOP FLY
local function stopFly()
    flying = false

    if bv then bv:Destroy() end
    if bg then bg:Destroy() end

    if flyConn then
        flyConn:Disconnect()
        flyConn = nil
    end
end

--// CHARACTER LOAD HANDLER
local function onCharacterLoaded(char)
    local hrp = char:WaitForChild("HumanoidRootPart")

    enableNoclip(char)
    teleportOnce(hrp)
    startFly(hrp) -- auto start
end

-- initial load
local char = lp.Character or lp.CharacterAdded:Wait()
onCharacterLoaded(char)

-- respawn support
lp.CharacterAdded:Connect(onCharacterLoaded)

--// TOGGLE FLY ANYTIME
UIS.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == TOGGLE_KEY then
        if flying then
            stopFly()
        else
            local char = lp.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                startFly(char.HumanoidRootPart)
            end
        end
    end
end)
